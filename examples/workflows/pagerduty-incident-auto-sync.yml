workflow:
  id: pagerduty-incident-auto-sync
  name: PagerDuty Incident Auto Sync
  description: Automatically sync Keep incidents to PagerDuty - create on firing, resolve on resolved
  triggers:
    - type: incident
      events:
        - created
        - updated

  actions:
    - name: create-pagerduty-incident
      # Only sync critical incidents to PagerDuty
      # Provider handles idempotency via incident_key - won't create duplicates
      if: "{{ incident.status.value }} == 'firing' and {{ incident.severity.value }} == 'critical'"
      provider:
        type: pagerduty
        config: "{{ providers.pagerduty2 }}"
        with:
          service_id: "P7CU6TM"
          title: "{{ incident.name }}"
          requester: "oleksandr.shostak@consultic.com"
          # Idempotency key: prevents duplicate PagerDuty incidents if this workflow runs multiple times
          incident_key: "{{ incident.id }}"
          body:
            type: incident_body
            details: |
              Incident: {{ incident.name }}
              Summary (user): {{ incident.user_summary }}
              Summary (generated): {{ incident.generated_summary }}

              Status: {{ incident.status.value }}
              Severity: {{ incident.severity }}

              Alert Count: {{ incident.alerts_count }}
              Services: keep.replace(keep.join({{ incident.services }}, ', '), 'null', 'N/A')
              Alert Sources: keep.join({{ incident.alert_sources }}, ', ')

              Created: {{ incident.creation_time }}
              Started: {{ incident.start_time }}
              Last Seen: {{ incident.last_seen_time }}

              Keep Incident: keep.incident_url(incident)
              Assignee: {{ incident.assignee }}

              Primary Alert:
              - Name: keep.get_alert_field(incident, 'name', 'N/A', 0)
              - Status: keep.get_alert_field(incident, 'status', 'N/A', 0)
              - Severity: keep.get_alert_field(incident, 'severity', 'N/A', 0)
              - Service: keep.get_alert_field(incident, 'service', 'N/A', 0)
              - Source: keep.get_alert_field(incident, 'source', 'N/A', 0)
              - Fingerprint: keep.get_alert_field(incident, 'fingerprint', 'N/A', 0)

              Alert Message:
              keep.get_alert_field(incident, 'message', 'N/A', 0)

              Alert Description:
              keep.get_alert_field(incident, 'description', 'N/A', 0)
    - name: log-pagerduty-created
      if: "{{ actions.create-pagerduty-incident.results.incident.id }} != ''"
      provider:
        type: console
        with:
          message: |
            PagerDuty incident created:
            - Keep Incident ID: {{ incident.id }}
            - PagerDuty Incident ID: {{ actions.create-pagerduty-incident.results.incident.id }}

    - name: acknowledge-pagerduty-incident
      # Acknowledge when incident is acknowledged in Keep and was originally critical
      if: "{{ incident.status.value }} == 'acknowledged' and {{ incident.severity.value }} == 'critical'"
      provider:
        type: pagerduty
        config: "{{ providers.pagerduty2 }}"
        with:
          # PagerDuty finds incident by incident_key (no incident_id needed)
          incident_key: "{{ incident.id }}"
          service_id: "P7CU6TM"
          title: "{{ incident.name }}"
          requester: "oleksandr.shostak@consultic.com"
          status: "acknowledged"
          body:
            type: incident_body
            details: "Incident acknowledged in Keep at {{ incident.last_seen_time }}"

    - name: log-pagerduty-acknowledged
      if: "{{ incident.status.value }} == 'acknowledged' and {{ incident.severity.value }} == 'critical'"
      provider:
        type: console
        with:
          message: |
            PagerDuty incident acknowledged:
            - Keep Incident ID: {{ incident.id }}
            - PagerDuty Incident ID: {{ incident.pagerduty_incident_id }}

    - name: resolve-pagerduty-incident
      # Resolve when incident is resolved in Keep and was originally critical
      if: "{{ incident.status.value }} == 'resolved' and {{ incident.severity.value }} == 'critical'"
      provider:
        type: pagerduty
        config: "{{ providers.pagerduty2 }}"
        with:
          # PagerDuty finds incident by incident_key (no incident_id needed)
          incident_key: "{{ incident.id }}"
          service_id: "P7CU6TM"
          title: "{{ incident.name }}"
          requester: "oleksandr.shostak@consultic.com"
          status: "resolved"
          resolution: "Incident resolved in Keep at {{ incident.last_seen_time }}"
          body:
            type: incident_body
            details: |
              Incident Resolved in Keep

              Incident: {{ incident.name }}
              Description: {{ incident.user_summary }}

              Status: {{ incident.status.value }}
              Severity: {{ incident.severity }}

              Keep Incident: keep.incident_url(incident)
              Resolved By: {{ incident.assignee }}

    - name: log-pagerduty-resolved
      if: "{{ incident.status.value }} == 'resolved' and {{ incident.severity.value }} == 'critical'"
      provider:
        type: console
        with:
          message: |
            PagerDuty incident resolved:
            - Keep Incident ID: {{ incident.id }}
            - PagerDuty Incident ID: {{ incident.pagerduty_incident_id }}
