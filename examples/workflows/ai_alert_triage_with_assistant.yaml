workflow:
  id: ai_alert_triage_openai
  name: "AI Alert Triage with OpenAI"
  description: Use OpenAI to analyze each alert and decide if it should be escalated to WARNING or HIGH
  disabled: false
  triggers:
    - type: alert
      cel: "providerType == 'mailgun' && severity == 'info'"
  steps:
    - name: ai_analyze_alert
      provider:
        type: openaiassistant
        config: "{{ providers.Triage }}"
        with:
          prompt: |
            Analyze this alert and decide the escalation severity:
            **Alert Name:** {{ alert.name }}
            - Source: {{ alert.source }}
            **Status:** {{ alert.status }}
            **Description:** {{ alert.description }}
            **Message:** {{ alert.message }}

            Determine if this alert should be escalated to:
            1. HIGH (production outages, security issues, data loss, critical service failures)
            2. WARNING (actionable but not critical)

            Respond ONLY with valid JSON in this exact format:

            {"recommended_severity": "warning", "reason": "brief explanation"}
            OR
            {"recommended_severity": "high", "reason": "brief explanation"}
  actions:
    - name: escalate_to_warning
      if: "'{{ steps.ai_analyze_alert.results.response.recommended_severity }}' == 'warning'"
      provider:
        type: keep
        config: "{{ providers.default-keep }}"
        with:
          read_only: true
          alert:
            name: "AI: {{ alert.name }}"
            status: firing
            severity: warning
            message: |
              AI ESCALATION: This alert has been automatically escalated to WARNING priority.

              AI Analysis: {{ steps.ai_analyze_alert.results.response.reason }}

              Original Alert Details:
              - Name: {{ alert.name }}
              - Description: {{ alert.description }}

              === Original Message ===
              {{ alert.message }}

              View original alert ID: {{ alert.id }}
            fingerprint: "ai-escalated-{{ alert.fingerprint }}"
    - name: escalate_to_high
      if: "'{{ steps.ai_analyze_alert.results.response.recommended_severity }}' == 'high'"
      provider:
        type: keep
        config: "{{ providers.default-keep }}"
        with:
          read_only: true
          alert:
            name: "AI: {{ alert.name }}"
            status: firing
            severity: high
            message: |
              AI ESCALATION: This alert has been automatically escalated to HIGH priority.

              AI Analysis: {{ steps.ai_analyze_alert.results.response.reason }}

              Original Alert Details:
              - Name: {{ alert.name }}
              - Description: {{ alert.description }}

              === Original Message ===
              {{ alert.message }}

              View original alert ID: {{ alert.id }}
            fingerprint: "ai-escalated-{{ alert.fingerprint }}"
