#!/bin/bash
# Monitor Keep server for malware activity
# Run this script periodically to verify no malware

SSH_KEY="/Users/oleksandr.shostak/Documents/SSH/ED25519-openssh"
SSH_CERT="/Users/oleksandr.shostak/Documents/SSH/cert.pub"
SERVER="root@keephq-cjm9.consultic.tech"
SSH_CMD="ssh -i $SSH_KEY -i $SSH_CERT $SERVER"

echo "=========================================="
echo "Keep Malware Monitor - $(date)"
echo "=========================================="
echo ""

# Check for malicious processes
echo "1. Checking for malicious processes..."
MALICIOUS_PROC=$($SSH_CMD "ps aux | grep -E '176.117.107.158|wget.*r.sh|curl.*r.sh|kdevtmpfsi|kinsing|xmrig' | grep -v grep")
if [ -z "$MALICIOUS_PROC" ]; then
    echo "✓ No malicious processes found"
else
    echo "⚠️  ALERT: Malicious processes detected!"
    echo "$MALICIOUS_PROC"
fi
echo ""

# Check frontend logs for new malware attempts
echo "2. Checking frontend logs for malware..."
MALWARE_COUNT=$($SSH_CMD "grep -c '176.117.107.158' /opt/keep/logs/frontend.log 2>/dev/null || echo 0" | tr -d '\n')
if [ "$MALWARE_COUNT" -eq 0 ] 2>/dev/null; then
    echo "✓ No malware activity in logs"
elif [ -n "$MALWARE_COUNT" ] && [ "$MALWARE_COUNT" -gt 0 ] 2>/dev/null; then
    echo "⚠️  ALERT: $MALWARE_COUNT malware attempts found in logs"
    LAST_ATTEMPT=$($SSH_CMD "grep '176.117.107.158' /opt/keep/logs/frontend.log | tail -1")
    echo "   Last attempt: $(echo "$LAST_ATTEMPT" | head -c 200)"
else
    echo "⚠️  WARNING: Could not check malware count (got: '$MALWARE_COUNT')"
fi
echo ""

# Check Keep API health
echo "3. Checking Keep API health..."
API_STATUS=$($SSH_CMD "curl -s -o /dev/null -w '%{http_code}' http://127.0.0.1:8080/")
if [ "$API_STATUS" = "200" ]; then
    echo "✓ Keep API responding (HTTP $API_STATUS)"
else
    echo "⚠️  WARNING: Keep API not responding properly (HTTP $API_STATUS)"
fi
echo ""

# Check system uptime
echo "4. Server uptime..."
$SSH_CMD "uptime -p"
echo ""

# Check Keep service status
echo "5. Keep service status..."
KEEP_STATUS=$($SSH_CMD "systemctl is-active keep.service")
if [ "$KEEP_STATUS" = "active" ]; then
    echo "✓ Keep service is active"
else
    echo "⚠️  WARNING: Keep service is $KEEP_STATUS"
fi
echo ""

echo "=========================================="
echo "Monitor complete - $(date)"
echo "=========================================="
