# /etc/nginx/sites-available/keep

# CORS allow list (adjust if you add more origins)
map $http_origin $cors_origin {
    default "";
    ~^https?://(keep-zpz9\.consultic\.tech|api\.keep-zpz9\.consultic\.tech)$ $http_origin;
}

# Allow webhook auth via either ?api_key=... or header X-API-KEY.
map $arg_api_key $keep_api_key {
    ""      $http_x_api_key;
    default $arg_api_key;
}

# UI
server {
    if ($host = keep-zpz9.consultic.tech) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name keep-zpz9.consultic.tech;
    return 301 https://$host$request_uri;


}
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name keep-zpz9.consultic.tech;
    ssl_certificate /etc/letsencrypt/live/keep-zpz9.consultic.tech/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/keep-zpz9.consultic.tech/privkey.pem; # managed by Certbot


    location / {
        # MGMT (HTTP & HTTPS)
        allow 37.19.12.62;
        allow 2a00:1528:40f:c7::/64;
        allow 45.152.190.14;
        allow 2a13:f700:fff0:c7::/64;
        allow 2a13:f700:fff0:c6::/64;

        # KUMA (kuma-q9an / kuma-y1g8)
        allow 46.62.254.197;
        allow 2a01:4f9:c013:72e8::1;
        allow 46.224.14.152;
        allow 2a01:4f8:c014:9b95::1;

        # SIGNOZ (signoz-t6cj)
        allow 168.119.106.119;
        allow 2a01:4f8:c010:aed8::1;

        # PUBLIC RANGE
        allow 192.145.82.0/24;
        allow 193.24.116.0/24;
        allow 45.152.190.0/24;
        allow 45.152.191.0/24;
        allow 89.116.135.0/24;
        allow 2a13:f700::/29;
        deny all;

        proxy_pass http://127.0.0.1:3000;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_cache_bypass $http_upgrade;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }



}

# API (with CORS)
server {
    if ($host = api.keep-zpz9.consultic.tech) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name api.keep-zpz9.consultic.tech;
    return 301 https://$host$request_uri;


}
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name api.keep-zpz9.consultic.tech;
    ssl_certificate /etc/letsencrypt/live/keep-zpz9.consultic.tech/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/keep-zpz9.consultic.tech/privkey.pem; # managed by Certbot

    proxy_hide_header Access-Control-Allow-Origin;
    proxy_hide_header Access-Control-Allow-Credentials;
    proxy_hide_header Access-Control-Allow-Methods;
    proxy_hide_header Access-Control-Allow-Headers;

    add_header Access-Control-Allow-Origin $cors_origin always;
    add_header Access-Control-Allow-Credentials true always;
    add_header Access-Control-Allow-Methods "GET, POST, PUT, PATCH, DELETE, OPTIONS" always;
    add_header Access-Control-Allow-Headers "Content-Type, X-API-KEY, Authorization, X-Requested-With" always;
    add_header Access-Control-Expose-Headers "Content-Length, Content-Type" always;
    add_header Vary "Origin" always;

    if ($request_method = OPTIONS) {
        return 204;
    }

    location ~ ^/alerts/event/ {
        #if ($keep_api_key = "") {
        #    return 403;
        #}
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header X-API-KEY $keep_api_key;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Generic webhook (header X-API-KEY or ?api_key=)
    location ~ ^/alerts/event/?$ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header X-API-KEY $keep_api_key;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Incident webhooks (e.g. PagerDuty -> /incidents/event/pagerduty)
    location ~ ^/incidents/event/ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header X-API-KEY $keep_api_key;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    # Generic incident webhook (header X-API-KEY or ?api_key=)
    location ~ ^/incidents/event/?$ {
        proxy_pass http://127.0.0.1:8080;
        proxy_set_header X-API-KEY $keep_api_key;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }

    location / {
        # MGMT (HTTP & HTTPS)
        allow 37.19.12.62;
        allow 2a00:1528:40f:c7::/64;
        allow 45.152.190.14;
        allow 2a13:f700:fff0:c7::/64;
        allow 2a13:f700:fff0:c6::/64;

        # KUMA (kuma-q9an / kuma-y1g8)
        allow 46.62.254.197;
        allow 2a01:4f9:c013:72e8::1;
        allow 46.224.14.152;
        allow 2a01:4f8:c014:9b95::1;

        # SIGNOZ (signoz-t6cj)
        allow 168.119.106.119;
        allow 2a01:4f8:c010:aed8::1;

        # PUBLIC RANGE
        allow 192.145.82.0/24;
        allow 193.24.116.0/24;
        allow 45.152.190.0/24;
        allow 45.152.191.0/24;
        allow 89.116.135.0/24;
        allow 2a13:f700::/29;
        deny all;

        proxy_pass http://127.0.0.1:8080;
        proxy_http_version 1.1;
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
    }



}

# WebSocket (Soketi)
server {
    if ($host = ws.keep-zpz9.consultic.tech) {
        return 301 https://$host$request_uri;
    } # managed by Certbot


    listen 80;
    server_name ws.keep-zpz9.consultic.tech;
    return 301 https://$host$request_uri;


}
server {
    listen 443 ssl http2;
    listen [::]:443 ssl http2;
    server_name ws.keep-zpz9.consultic.tech;
    ssl_certificate /etc/letsencrypt/live/keep-zpz9.consultic.tech/fullchain.pem; # managed by Certbot
    ssl_certificate_key /etc/letsencrypt/live/keep-zpz9.consultic.tech/privkey.pem; # managed by Certbot


    location / {
        # MGMT (HTTP & HTTPS)
        allow 37.19.12.62;
        allow 2a00:1528:40f:c7::/64;
        allow 45.152.190.14;
        allow 2a13:f700:fff0:c7::/64;
        allow 2a13:f700:fff0:c6::/64;

        # KUMA (kuma-q9an / kuma-y1g8)
        allow 46.62.254.197;
        allow 2a01:4f9:c013:72e8::1;
        allow 46.224.14.152;
        allow 2a01:4f8:c014:9b95::1;

        # SIGNOZ (signoz-t6cj)
        allow 168.119.106.119;
        allow 2a01:4f8:c010:aed8::1;

        # PUBLIC RANGE
        allow 192.145.82.0/24;
        allow 193.24.116.0/24;
        allow 45.152.190.0/24;
        allow 45.152.191.0/24;
        allow 89.116.135.0/24;
        allow 2a13:f700::/29;
        deny all;

        proxy_pass http://127.0.0.1:6001;
        proxy_http_version 1.1;
        proxy_set_header Upgrade $http_upgrade;
        proxy_set_header Connection "upgrade";
        proxy_set_header Host $host;
        proxy_set_header X-Real-IP $remote_addr;
        proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
        proxy_set_header X-Forwarded-Proto $scheme;
        proxy_read_timeout 86400;
    }



}
